# 网络入侵检测系统需求与设计文档

## 1. 概述

本项目旨在构建一个轻量级、可扩展的网络入侵检测系统。系统由两大部分组成：**探针（Probe）**和**云端服务（Cloud Service）**。
探针部署在目标环境中，负责实时流量分析和威胁检测；云端服务负责规则管理、下发以及日志的接收和展示。

## 2. 系统架构

系统采用 Client-Server 架构，探针端通过 HTTP 协议与云端服务进行通信。

### 2.1 核心组件

1.  **云端服务 (Cloud Service)**
    *   **前端 (Frontend)**: 提供用户交互界面，用于规则编辑、版本管理和日志实时展示。
    *   **后端 (Backend)**: 处理业务逻辑，存储规则和日志数据，提供 API 接口供前端和探针调用。

2.  **探针系统 (Probe System)**
    *   **探针管理程序 (Probe Manager)**: 系统的核心守护进程，负责与云端通信，管理具体的检测探针（启动、停止、配置更新），并收集日志上报。
    *   **网络入侵检测探针 (NIDS Probe)**: 基于 Suricata 实现，负责实际的流量分析和入侵检测。

### 2.2 设计原则

*   **GPL 合规性**: 鉴于 Suricata 采用 GPL 协议，本系统采用**进程隔离**的方式。探针管理程序与 Suricata 运行在不同的进程中，通过标准 IPC（如 Unix Domain Socket）或文件进行交互，确保私有代码（探针管理程序）不被 GPL 传染。
*   **模块化**: 探针管理程序设计为通用框架，当前仅实现 NIDS 功能，未来可扩展防火墙、主机入侵检测等功能。
*   **可维护性**: 支持 Suricata 源码集成编译，便于后续定制开发。

## 3. 详细需求

### 3.1 云端服务

#### 3.1.1 规则管理
*   支持入侵检测规则的增删改查（CRUD）。
*   **版本控制**: 每次规则集变更应生成新的版本号，支持查看历史版本。
*   **规则下发**: 支持将指定版本的规则集下发给探针（或由探针拉取）。

#### 3.1.2 日志展示
*   接收探针上报的告警和检测日志。
*   提供实时日志展示页面，支持基本的筛选（如时间、探针ID、告警级别）。

### 3.2 探针管理程序 (Probe Manager)

*   **通信能力**: 实现 HTTP 客户端，与云端服务交互。
*   **规则同步**: 定期或按需从云端获取最新规则，保存到本地，并通知 NIDS 探针进行热更新。
*   **日志收集**: 监听 NIDS 探针产生的日志（如读取 `eve.json` 或监听 Socket），格式化后批量或实时上报至云端。
*   **进程管理**: 负责启动、监控 Suricata 进程，确保其正常运行。

### 3.3 网络入侵检测探针 (NIDS Probe)

*   **基于 Suricata**: 使用 Suricata 作为核心检测引擎。
*   **源码集成**: 将 Suricata 源码纳入项目树，支持在项目中编译 Suricata。
*   **热更新**: 支持在不重启进程的情况下重新加载规则（Suricata Reload 机制）。
*   **基础规则**: 内置一套默认的基础检测规则，确保系统启动即具备基本防护能力。

## 4. 技术方案与设计

### 4.1 技术栈

| 组件 | 技术选型 | 说明 |
| :--- | :--- | :--- |
| **云端后端** | Python (UV) / FastAPI | 高性能异步 Web 框架，依赖管理使用 UV |
| **云端数据库** | MySQL | 持久化存储规则、日志及配置信息 |
| **云端前端** | TypeScript / Vite / Tailwind / Shadcn | 现代化的 React 生态开发栈 |
| **探针管理程序** | C++ / CMake | 高性能系统级编程，跨平台构建支持 |
| **NIDS 引擎** | Suricata | 开源高性能网络威胁检测引擎 |
| **环境** | x86_64 / Ubuntu 22+ | 开发与运行目标环境 |

### 4.2 数据交互设计

通信协议：HTTP / JSON

#### 4.2.1 接口定义 (示例)

1.  **心跳/配置检查 (Probe -> Cloud)**
    *   `POST /api/probe/heartbeat`
    *   Request: `{ "probe_id": "...", "version": "1.0", "rule_version": "v10" }`
    *   Response: `{ "status": "ok", "new_rule_version": "v11", "download_url": "..." }`

2.  **日志上报 (Probe -> Cloud)**
    *   `POST /api/probe/logs`
    *   Request: `{ "probe_id": "...", "logs": [ { ...suricata_eve_log... }, ... ] }`

3.  **规则下载 (Probe -> Cloud)**
    *   `GET /api/rules/download/{version}`

### 4.3 目录结构规划

```
/
├── cloud/
│   ├── backend/        # FastAPI Python 代码
│   │   ├── app/
│   │   ├── requirements.txt (或 pyproject.toml)
│   │   └── ...
│   └── frontend/       # Vite + React 前端代码
│       ├── src/
│       ├── package.json
│       └── ...
├── probe/
│   ├── manager/        # C++ 探针管理程序源码
│   │   ├── src/
│   │   ├── include/
│   │   └── CMakeLists.txt
│   └── suricata/       # Suricata 源码 (Git Submodule 或 源码拷贝)
│       └── ...
├── specs/              # 文档
│   └── 0001-spec.md
└── README.md
```

### 4.4 探针运行流程

1.  **启动阶段**: Probe Manager 启动 -> 读取本地配置 -> 启动 Suricata 子进程。
2.  **运行阶段**:
    *   Probe Manager 周期性向 Cloud 发送心跳。
    *   若 Cloud 返回新规则版本，Probe Manager 下载规则文件至共享目录。
    *   Probe Manager 发送信号（如 `SIGUSR2` 或通过 Socket 命令）给 Suricata 触发规则重载。
    *   Suricata 将检测日志输出到指定位置（如 Unix Domain Socket）。
    *   Probe Manager 读取日志，缓冲并批量 POST 发送给 Cloud。

## 5. 开发计划

1.  **第一阶段**: 环境搭建与基础框架。初始化 Git 仓库，搭建 Cloud 前后端框架，编写 Probe Manager 基础 C++ 工程结构。
2.  **第二阶段**: Suricata 集成。将 Suricata 源码合入，实现 Probe Manager 对 Suricata 的启动与监控。
3.  **第三阶段**: 规则下发功能。实现 Cloud 规则编辑 API，Probe 规则下载与 Suricata 热更新逻辑。
4.  **第四阶段**: 日志上报与展示。实现 Suricata 日志解析、上报 API 及前端实时展示。
