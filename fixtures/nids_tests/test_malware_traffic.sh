#!/bin/bash
# NIDS 恶意流量模拟测试
# 用法: ./test_malware_traffic.sh

set -e

LOG_DIR="${1:-/var/log/suricata}"

echo "=================================================="
echo "  NIDS Malware Traffic Simulation Tests"
echo "=================================================="
echo "Log Dir: $LOG_DIR"
echo ""
echo "WARNING: This test generates traffic patterns similar to malware."
echo "Run only in isolated test environments!"
echo ""

# 检查 curl 是否安装
if ! command -v curl &> /dev/null; then
    echo "Error: curl is not installed"
    echo "Install with: sudo apt-get install -y curl"
    exit 1
fi

# 记录初始告警数
if [ -f "$LOG_DIR/eve.json" ]; then
    INITIAL_ALERTS=$(grep -c '"event_type":"alert"' "$LOG_DIR/eve.json" 2>/dev/null || echo 0)
else
    INITIAL_ALERTS=0
fi
echo "Initial alerts: $INITIAL_ALERTS"
echo ""

check_alerts() {
    if [ -f "$LOG_DIR/eve.json" ]; then
        CURRENT_ALERTS=$(grep -c '"event_type":"alert"' "$LOG_DIR/eve.json" 2>/dev/null || echo 0)
        NEW_ALERTS=$((CURRENT_ALERTS - INITIAL_ALERTS))
        echo "New alerts: $NEW_ALERTS"
        INITIAL_ALERTS=$CURRENT_ALERTS
    fi
    echo ""
}

echo "=== 1. Known Malicious Domain Access ==="

echo ">>> Google Malware Test URL"
curl -s -o /dev/null --max-time 5 "http://malware.testing.google.com/testing/malware/" 2>/dev/null || true
sleep 1
check_alerts

echo ">>> Suspicious Domain Pattern"
curl -s -o /dev/null --max-time 5 "http://evil-domain-test-12345.com/" 2>/dev/null || true
sleep 1
check_alerts

echo "=== 2. Suspicious User-Agents ==="

echo ">>> Botnet-like User-Agent"
curl -s -o /dev/null --max-time 5 \
    -A "Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1; SV1; .NET CLR 1.1.4322)" \
    "http://httpbin.org/user-agent" 2>/dev/null || true
sleep 1
check_alerts

echo ">>> Malware C2 User-Agent Pattern"
curl -s -o /dev/null --max-time 5 \
    -A "WinHttp.WinHttpRequest.5" \
    "http://httpbin.org/user-agent" 2>/dev/null || true
sleep 1
check_alerts

echo ">>> PowerShell Download Cradle Pattern"
curl -s -o /dev/null --max-time 5 \
    -A "Mozilla/5.0 (Windows NT; Windows NT 10.0; en-US) WindowsPowerShell/5.1" \
    "http://httpbin.org/user-agent" 2>/dev/null || true
sleep 1
check_alerts

echo "=== 3. Suspicious File Downloads ==="

echo ">>> Executable Download Pattern"
curl -s -o /dev/null --max-time 5 "http://httpbin.org/bytes/1024" \
    -H "Accept: application/octet-stream" 2>/dev/null || true
sleep 1
check_alerts

echo "=== 4. C2 Communication Patterns ==="

echo ">>> Beaconing Pattern (multiple requests)"
for i in $(seq 1 5); do
    curl -s -o /dev/null --max-time 2 "http://httpbin.org/get?beacon=$i" 2>/dev/null || true
    sleep 1
done
check_alerts

echo ">>> Base64 Encoded Data in URL"
ENCODED=$(echo "malicious command" | base64)
curl -s -o /dev/null --max-time 5 "http://httpbin.org/get?data=$ENCODED" 2>/dev/null || true
sleep 1
check_alerts

echo "=== 5. DNS-based Attacks ==="

if command -v dig &> /dev/null; then
    echo ">>> DNS Tunneling Pattern (long subdomain)"
    LONG_SUB=$(python3 -c "import random,string; print(''.join(random.choices(string.ascii_lowercase, k=50)))")
    dig "$LONG_SUB.example.com" 2>/dev/null || true
    sleep 1
    check_alerts
    
    echo ">>> TXT Record Query (data exfil pattern)"
    dig -t TXT example.com 2>/dev/null || true
    sleep 1
    check_alerts
else
    echo "Skipping DNS tests - dig not installed"
fi

echo "=== 6. Crypto Mining Indicators ==="

echo ">>> Mining Pool Domain Access"
# 使用安全的测试 URL
curl -s -o /dev/null --max-time 5 \
    -H "X-Mining-Extension: test" \
    "http://httpbin.org/get" 2>/dev/null || true
sleep 1
check_alerts

echo "=== 7. Ransomware Indicators ==="

echo ">>> Tor Hidden Service Pattern"
curl -s -o /dev/null --max-time 5 "http://httpbin.org/get?onion=test" 2>/dev/null || true
sleep 1
check_alerts

echo ">>> Bitcoin Address Pattern"
curl -s -o /dev/null --max-time 5 "http://httpbin.org/get?btc=1BvBMSEYstWetqTFn5Au4m4GFg7xJaNVN2" 2>/dev/null || true
sleep 1
check_alerts

# 最终统计
echo "=================================================="
echo "  Test Summary"
echo "=================================================="
if [ -f "$LOG_DIR/eve.json" ]; then
    FINAL_ALERTS=$(grep -c '"event_type":"alert"' "$LOG_DIR/eve.json" 2>/dev/null || echo 0)
    echo "Total alerts in eve.json: $FINAL_ALERTS"
    
    echo ""
    echo "Recent malware-related alerts:"
    tail -100 "$LOG_DIR/eve.json" 2>/dev/null | grep '"event_type":"alert"' | \
        grep -iE 'malware|trojan|bot|c2|c&c|miner|ransomware' | tail -5 | \
        python3 -c "import sys,json; [print(f\"  - {json.loads(l).get('alert',{}).get('signature','N/A')}\") for l in sys.stdin]" 2>/dev/null || echo "  (none or error reading)"
else
    echo "eve.json not found at $LOG_DIR/eve.json"
fi
echo "=================================================="
